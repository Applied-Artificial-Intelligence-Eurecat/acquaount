units(RH)<-"%"
RH<-drop_units(RH)
} else if (RH_type<-2){
t2d<-as.numeric(unlist(RH))
units(t2d)<-Units_RH
units(t2d)<-"°C"
t2d<-drop_units(t2d)
}
#ET0 calculation
tmean <- ((tmax + tmin) / 2)
delta <- (4098 * (0.6108 * exp(17.27 * tmean/(tmean + 237.3))))/(tmean +
237.3)^2
# atmospheric pressure [KPa]
Patm <- 101.3 * ((293 - 0.0065 * elev) / 293)^5.26
# if solar radiation is not present, use Hargreaves’ radiation formula
if( is.na(wind)){
wind=2 #m/s
}
psy_constant <- 0.000665 * Patm
DT = (delta/(delta + psy_constant * (1 + 0.34 * wind)))
PT <- (psy_constant)/(delta + psy_constant * (1 + 0.34 *
wind))
TT <- (900/(tmean + 273)) * wind
# Mean Saturation vapor Pressure [KPa]
es_Tx <- 0.6108 * exp((17.27 * tmax)/(tmax + 237.3))
es_Tn <- 0.6108 * exp((17.27 * tmin)/(tmin + 237.3))
es <- ((es_Tx + es_Tn) / 2)
#Relative humidity
if(RH_type<-1){
ea <- RH/100 * (es) # if we have relative humidity as an input
}else if (RH_type<-2){
ea <- 0.6108 * exp((17.27 * t2d)/(t2d + 237.3)) # if we have dewpoint temperature as an input
}
j <- as.numeric(format(date, "%j"))
dr <- 1 + 0.033 * cos(2 * pi * j/365)
solar_decli <- 0.409 * sin((2 * pi * j/365) - 1.39)
lat_rad <- (pi/180) * lat
ws <- acos(-tan(lat_rad) * tan(solar_decli))
Gsc <- 0.082
ra <- (24 * (60)/pi) * Gsc * dr * ((ws * sin(lat_rad) *
sin(solar_decli)) + (cos(lat_rad) * cos(solar_decli) *
sin(ws)))
# if solar radiation is not present, use Hargreaves’ radiation formula
if( is.na(Rs)){
kRs=0.16
Rs=kRs * sqrt(tmax-tmin) * ra
}
rso <- (0.75 + (2 * 10^-5) * elev) * ra
Rns <- (1 - 0.23) * Rs
sigma <- 4.903 * 10^-9
ratio<-Rs/rso
ratio[ratio>=1]=1
Rnl <- sigma * ((((tmax+273.16)^4) + ((tmin+273.16)^4))/2) *
(0.34 - 0.14 * sqrt(ea)) * (1.35 * ratio - 0.35)
Rn <- Rns - Rnl
Rng <- 0.408 * Rn
# If we are inside greenhouses we use the Hargreaves equation
if (in_greenhouse==1){
tau= 0.9 # transmissivity of greenhouse cover R_inside/R_outside
ET0 <- 0.0023 * ra * tau * sqrt(tmax - tmin) * (tmean + 17.8)
} else{
ETrad <- DT * Rng
ETwind <- PT * TT * (es - ea)
ET0 <- ETwind + ETrad
}
#Calculation of Open water evaporation
#Vapor pressure deficit
VPD= es_Tx - ea
# Bulk Aerodynamic Expression [Mj m-2]
Ba = 6.43 * (0.5 + (0.54 * wind * 0.75)) * VPD
emiss_water <- 0.92   #NB: costant
Rls <- (Rnl * emiss_water) - (0.0000000567 * emiss_water * ((tmean + 273.15) ^ 4))
Qt <- array(0,dim=length(tmean))
for (i in 1:length(j)) {
#if the month is July or not
if (j[i] < 183) {Qt[i] = (0.5 * Rns + 0.8 * Rls)}
if (j[i] >= 183) {Qt[i] = (0.5 * Rns + 1.3 * Rls)}
}
# Open Water ET [mm day-1], hourly
OWET = ((0.408 * 0.0864 * ((Rns + Rls)- Qt) * delta) + (Ba * psy_constant)) / (delta + psy_constant)
OWET[OWET<0]=0
OWET=as.numeric(OWET)
Evapotranspiration <- list("ET0"=ET0,"OWET"=OWET)
return(Evapotranspiration)
}
Irr_req=as.numeric(array(0,dim=nrow(dataset_model)))
ETa_rf=as.numeric(array(0,dim=nrow(dataset_model)))
ETa_full=as.numeric(array(0,dim=nrow(dataset_model)))
Dr=as.numeric(array(0,dim=nrow(dataset_model)))
Irr_sched=as.numeric(array(0,dim=nrow(dataset_model)))
Irr_vol_matrix<-data.frame(matrix(nrow = nrow(dataset_model), ncol = nrow(cultivated_area_basin)))
colnames(Irr_vol_matrix)<-cultivated_area_basin$crop
# Convert the date into specific formats
j <- as.numeric(format(date, "%j")) #Julian day
year=as.numeric(format(date, "%Y")) #year
year_list=unique(year) #list of years of the simulation
l<-c(1:length(date)) #posizioni delle righe nel dataframe
#define the last day of each year, to understand if it's 365 or 366 days
end<-array(0,length(year_list))
end[length(year_list)]<-j[length(j)]
for (p in 1:(length(l)-1)){
if(j[p]>j[p+1]){
end[round(l[p]/365)]<-j[p]
}
}
# Create summary table with main variables
variables_st=list("Date","precipitation","P_eff","ponding","DP","moisture","ET0","Deficit meteo","SAT_daily","theta_fc","TAW","RAW","kc","ETc","ks","Dr","ETa","Irr_req","Irr_sched","Deficit final","moisture_new")
summary_table=data.frame(matrix(NA,nrow = nrow(dataset_model),ncol = length(variables_st)))
colnames(summary_table)=variables_st
i=1
crop=cultivated_area_basin$crop[i]
in_greenhouse=cultivated_area_basin[i,3]
if(in_greenhouse==1){
precipitation=0
}
precipitation=rep(0,nrow(dataset_model))
if(in_greenhouse==1){
precipitation=rep(0,nrow(dataset_model))
}
Evapotranspiration <- FAO_ET0_function(lat, tmin, tmax, Rs, wind, RH, RH_type, elev, date, in_greenhouse, "°C","W/m2","m/s","%","m")
#ET0 calculation
tmean <- ((tmax + tmin) / 2)
delta <- (4098 * (0.6108 * exp(17.27 * tmean/(tmean + 237.3))))/(tmean +
237.3)^2
# atmospheric pressure [KPa]
Patm <- 101.3 * ((293 - 0.0065 * elev) / 293)^5.26
# if solar radiation is not present, use Hargreaves’ radiation formula
if( is.na(wind)){
wind=2 #m/s
}
psy_constant <- 0.000665 * Patm
DT = (delta/(delta + psy_constant * (1 + 0.34 * wind)))
PT <- (psy_constant)/(delta + psy_constant * (1 + 0.34 *
wind))
TT <- (900/(tmean + 273)) * wind
# Mean Saturation vapor Pressure [KPa]
es_Tx <- 0.6108 * exp((17.27 * tmax)/(tmax + 237.3))
es_Tn <- 0.6108 * exp((17.27 * tmin)/(tmin + 237.3))
es <- ((es_Tx + es_Tn) / 2)
#Relative humidity
if(RH_type<-1){
ea <- RH/100 * (es) # if we have relative humidity as an input
}else if (RH_type<-2){
ea <- 0.6108 * exp((17.27 * t2d)/(t2d + 237.3)) # if we have dewpoint temperature as an input
}
j <- as.numeric(format(date, "%j"))
dr <- 1 + 0.033 * cos(2 * pi * j/365)
solar_decli <- 0.409 * sin((2 * pi * j/365) - 1.39)
lat_rad <- (pi/180) * lat
ws <- acos(-tan(lat_rad) * tan(solar_decli))
Gsc <- 0.082
ra <- (24 * (60)/pi) * Gsc * dr * ((ws * sin(lat_rad) *
sin(solar_decli)) + (cos(lat_rad) * cos(solar_decli) *
sin(ws)))
# if solar radiation is not present, use Hargreaves’ radiation formula
if( is.na(Rs)){
kRs=0.16
Rs=kRs * sqrt(tmax-tmin) * ra
}
is.na(Rs)
# if solar radiation is not present, use Hargreaves’ radiation formula
if(anyNA(Rs)){
kRs=0.16
Rs=kRs * sqrt(tmax-tmin) * ra
}
rso <- (0.75 + (2 * 10^-5) * elev) * ra
Rns <- (1 - 0.23) * Rs
sigma <- 4.903 * 10^-9
ratio<-Rs/rso
ratio[ratio>=1]=1
Rnl <- sigma * ((((tmax+273.16)^4) + ((tmin+273.16)^4))/2) *
(0.34 - 0.14 * sqrt(ea)) * (1.35 * ratio - 0.35)
Rn <- Rns - Rnl
Rng <- 0.408 * Rn
# If we are inside greenhouses we use the Hargreaves equation
if (in_greenhouse==1){
tau= 0.9 # transmissivity of greenhouse cover R_inside/R_outside
ET0 <- 0.0023 * ra * tau * sqrt(tmax - tmin) * (tmean + 17.8)
} else{
ETrad <- DT * Rng
ETwind <- PT * TT * (es - ea)
ET0 <- ETwind + ETrad
}
ET0
ETrad <- DT * Rng
ETwind <- PT * TT * (es - ea)
ET0 <- ETwind + ETrad
ET0
tau= 0.9 # transmissivity of greenhouse cover R_inside/R_outside
ra=ra/2.45 # conversion from MJ/m2/day into mm/day
ET0 <- 0.0023 * ra * tau * sqrt(tmax - tmin) * (tmean + 17.8)
ET0
###################################################################################################################################à
#################################### FUNCTION FOR SOIL WATER BALANCE MODEL ##################################################
##### ESTIMATE PEDOTRANSFER FUNCTIONS ############
PTFs_function <- function(P_sand,P_silt,P_clay,P_om,Pb){
# Method RAWLS et al. 2003 --------------------------------------------------------------------------------
x= - 0.837531 + 0.430183*P_om
y= - 1.40744 + 0.0661969*P_clay
z= - 1.51866 + 0.0393284*P_sand
theta_fcA= (29.7528 + 10.3544*(0.0461615 + 0.290955*x - 0.0496845*x^2 + 0.00704802*x^3 + 0.269101*y - 0.176528*x*y +
0.0543138*x^2*y + 0.1982*y^2- 0.060699*y^3 - 0.320249*z - 0.0111693*x^2*z +
0.14104*y*z + 0.0657345*x*y*z - 0.102026*y^2*z - 0.04012*z^2 + 0.160838*x*z^2
- 0.121392*y*z^2 - 0.0616676*z^3)) /100 # divide by 100 to have the results as a fraction
theta_wpA = (14.2568 + 7.36318*(0.06865 + 0.108713*x - 0.0157225*x^2 + 0.00102805*x^3
+ 0.886569*y - 0.223581*x*y + 0.0126379*x^2*y - 0.017059*y^2
+ 0.0135266*x*y^2 - 0.0334434*y^3 - 0.0535182*z - 0.0354271*x*z
- 0.00261313*x^2*z - 0.154563*y*z - 0.0160219*x*y*z - 0.0400606*y^2*z
- 0.104875*z^2 + 0.0159857*x*z^2 - 0.0671656*y*z^2 - 0.0260699*z^3)) /100 # divide by 100 to have the results as a fraction
# Method from Zacharias et al., 2006 ------------------------------------------------------------------------
if(P_sand < 66.5){
theta_sat=0.788+0.001*P_clay-0.263*Pb
ln_alpha=-0.648+0.023*P_sand+0.044*P_clay-3.168*Pb
n=1.392-0.418*P_sand^-0.024+1.212*P_clay^-0.704
} else{
theta_sat=0.890-0.001*P_clay-0.276*Pb
ln_alpha=-4.197+0.013*P_sand+0.076*P_clay-0.276*Pb
n=-2.562+7*10^-9*P_sand^4.004+3.750*P_clay^-0.016
}
alpha=exp(ln_alpha)
m=1-1/n
theta_fcB=theta_sat/(1+(alpha*33)^n)^m
theta_wpB=theta_sat/(1+(alpha*1500)^n)^m
soil_AWCB=theta_sat
### ROSETTA method (Zhang and Schaap., 2017) -----------------------------------------------------------------
vars <- c('sand', 'silt', 'clay', 'bd')
suelos <- data.frame(#"soil"="Tunisia",
#"hzdept_r"=0,
#"hzdepb_r"=100,
"sand"= P_sand,
"silt"= P_silt,
"clay"= P_clay,
"bd"= Pb,
"Corg" = P_om)
r <- ROSETTA(suelos, vars = vars, v = '3')
# flatten to data.frame
vg <- KSSL_VG_model(VG_params = r, phi_min = 10^-3, phi_max=10^6)
# extract VWC at specific matric potentials (kPa)
d <- data.frame(
#soil = r$soil,
sat = vg$VG_function(0),
fc = vg$VG_function(33),
pwp = vg$VG_function(1500)
)
# flatten to data.frame
theta_fcC=d$fc
theta_wpC=d$pwp
soil_AWCC=d$sat
### EUPTFv2, Szabo et al 2021 ---------------------------------------------------------------------------------
soil <- data.frame("DEPTH_M"=30,
"USSAND"=P_sand,
"USSILT"=P_silt,
"USCLAY"=P_clay,
"OC"=P_om,
"BD"=Pb)
# SATURATION -------------
load(paste(wd,"/Functions/Pedotransfer_functions/THS_PTF03.rdata",sep=""))
soil_AWCD <- predict(THS_PTF03,
data=soil,
type = "response",
num.threads = detectCores()-1)
soil_AWCD <- soil_AWCD$prediction
# FIELD CAPACITY ---------
load(paste(wd,"/Functions/Pedotransfer_functions/FC_PTF02.rdata",sep=""))
theta_fcD <- predict(FC_PTF02,
data=soil,
type = "response",
num.threads = detectCores()-1)
theta_fcD <- theta_fcD$predictions
# WILTING POINT ---------
load(paste(wd,"/Functions/Pedotransfer_functions/WP_PTF02.rdata",sep=""))
theta_wpD <- predict(WP_PTF02,
data=soil,
type = "response",
num.threads = detectCores()-1)
theta_wpD <- theta_wpD$predictions
########################### MAKE THE ENSEMBLE MEAN AMONG DIFFERENT PTFs
theta_fcE=mean(c(theta_fcA,theta_fcB,theta_fcC,theta_fcD))
theta_wpE=mean(c(theta_wpA,theta_wpB,theta_wpC,theta_wpD))
soil_AWCE=mean(c(soil_AWCB,soil_AWCC,soil_AWCD))
PTF=data.frame("SAT"=soil_AWCE,
"FC"=theta_fcE,
"WP"=theta_wpE)
theta_fcE=PTF$FC
theta_wpE=PTF$WP
soil_SATE=PTF$SAT
theta_fc=theta_fcE
theta_wp=theta_wpE
soil_SAT=soil_SATE
#Check that theta_fc is not greater than soil_SAT
if(theta_fc>soil_SAT){
soil_SAT=theta_fc
}else{
soil_SAT=soil_SAT
}
WRP=data.frame("SAT"=soil_SAT,
"FC"=theta_fc,
"WP"=theta_wp)
return(WRP)
}
#### AGGREGATE PAST AND FUTURE DATA ###############
#### Calculate ET0 with FAO method
FAO_ET0_function <- function (lat, tmin, tmax, Rs, wind, RH, RH_type, elev, date, in_greenhouse, Units_T,Units_Rs,Units_wind,Units_RH,Units_z)
{
# Units_T="°C"
# Units_Rs="W/m2"
# Units_wind="m/s"
# Units_RH="%"
# Units_z="m"
#convertire dati climatici nell'unità di misura corretta
tmin<-as.numeric(unlist(tmin))
tmax<-as.numeric(unlist(tmax))
Rs<-as.numeric(unlist(Rs))
wind<-as.numeric(unlist(wind))
elev<-as.numeric(unlist(elev))
units(tmin)<-Units_T
units(tmin)<-"°C"
tmin<-drop_units(tmin)
units(tmax)<-Units_T
units(tmax)<-"°C"
tmax<-drop_units(tmax)
units(Rs)<-Units_Rs
units(Rs)<-"MJ/m2/day"
Rs<-drop_units(Rs)
units(wind)<-Units_wind
units(wind)<-"m/s"
wind<-drop_units(wind)
units(elev)<-Units_z
units(elev)<-"m"
elev<-drop_units(elev)
if(RH_type<-1){
RH<-as.numeric(unlist(RH))
units(RH)<-Units_RH
units(RH)<-"%"
RH<-drop_units(RH)
} else if (RH_type<-2){
t2d<-as.numeric(unlist(RH))
units(t2d)<-Units_RH
units(t2d)<-"°C"
t2d<-drop_units(t2d)
}
#ET0 calculation
tmean <- ((tmax + tmin) / 2)
delta <- (4098 * (0.6108 * exp(17.27 * tmean/(tmean + 237.3))))/(tmean +
237.3)^2
# atmospheric pressure [KPa]
Patm <- 101.3 * ((293 - 0.0065 * elev) / 293)^5.26
# if solar radiation is not present, use Hargreaves’ radiation formula
if( is.na(wind)){
wind=2 #m/s
}
psy_constant <- 0.000665 * Patm
DT = (delta/(delta + psy_constant * (1 + 0.34 * wind)))
PT <- (psy_constant)/(delta + psy_constant * (1 + 0.34 *
wind))
TT <- (900/(tmean + 273)) * wind
# Mean Saturation vapor Pressure [KPa]
es_Tx <- 0.6108 * exp((17.27 * tmax)/(tmax + 237.3))
es_Tn <- 0.6108 * exp((17.27 * tmin)/(tmin + 237.3))
es <- ((es_Tx + es_Tn) / 2)
#Relative humidity
if(RH_type<-1){
ea <- RH/100 * (es) # if we have relative humidity as an input
}else if (RH_type<-2){
ea <- 0.6108 * exp((17.27 * t2d)/(t2d + 237.3)) # if we have dewpoint temperature as an input
}
j <- as.numeric(format(date, "%j"))
dr <- 1 + 0.033 * cos(2 * pi * j/365)
solar_decli <- 0.409 * sin((2 * pi * j/365) - 1.39)
lat_rad <- (pi/180) * lat
ws <- acos(-tan(lat_rad) * tan(solar_decli))
Gsc <- 0.082
ra <- (24 * (60)/pi) * Gsc * dr * ((ws * sin(lat_rad) *
sin(solar_decli)) + (cos(lat_rad) * cos(solar_decli) *
sin(ws)))
# if solar radiation is not present, use Hargreaves’ radiation formula
if(anyNA(Rs)){
kRs=0.16
Rs=kRs * sqrt(tmax-tmin) * ra
}
rso <- (0.75 + (2 * 10^-5) * elev) * ra
Rns <- (1 - 0.23) * Rs
sigma <- 4.903 * 10^-9
ratio<-Rs/rso
ratio[ratio>=1]=1
Rnl <- sigma * ((((tmax+273.16)^4) + ((tmin+273.16)^4))/2) *
(0.34 - 0.14 * sqrt(ea)) * (1.35 * ratio - 0.35)
Rn <- Rns - Rnl
Rng <- 0.408 * Rn
# If we are inside greenhouses we use the Hargreaves equation
if (in_greenhouse==1){
tau= 0.9 # transmissivity of greenhouse cover R_inside/R_outside
ra=ra/2.45 # conversion from MJ/m2/day into mm/day
ET0 <- 0.0023 * ra * tau * sqrt(tmax - tmin) * (tmean + 17.8)
} else{
ETrad <- DT * Rng
ETwind <- PT * TT * (es - ea)
ET0 <- ETwind + ETrad
}
#Calculation of Open water evaporation
#Vapor pressure deficit
VPD= es_Tx - ea
# Bulk Aerodynamic Expression [Mj m-2]
Ba = 6.43 * (0.5 + (0.54 * wind * 0.75)) * VPD
emiss_water <- 0.92   #NB: costant
Rls <- (Rnl * emiss_water) - (0.0000000567 * emiss_water * ((tmean + 273.15) ^ 4))
Qt <- array(0,dim=length(tmean))
for (i in 1:length(j)) {
#if the month is July or not
if (j[i] < 183) {Qt[i] = (0.5 * Rns + 0.8 * Rls)}
if (j[i] >= 183) {Qt[i] = (0.5 * Rns + 1.3 * Rls)}
}
# Open Water ET [mm day-1], hourly
OWET = ((0.408 * 0.0864 * ((Rns + Rls)- Qt) * delta) + (Ba * psy_constant)) / (delta + psy_constant)
OWET[OWET<0]=0
OWET=as.numeric(OWET)
Evapotranspiration <- list("ET0"=ET0,"OWET"=OWET)
return(Evapotranspiration)
}
#### Calculate Rooting depth development #############################à
RD_increment<-function(s,h,day,L12,RD,L12_den,type){
if (type==1){
#annual crops
daily_rooting_depth <- ifelse(s<h & s<=day & (s+L12-1)>day,((RD[2]-RD[1])/(L12_den))*(day-s+1)+RD[1],0)+
ifelse(s<h & (s+L12-1)<=day & day<=h, RD[2],0)+
ifelse(s>h & s<=day & (s+L12-1)>day, ((RD[2]-RD[1])/(L12_den))*(day-s+1)+RD[1],0)+
ifelse(s>h & (h-(LGP-L12))>day,((RD[2]-RD[1])/(L12_den))*(day-s+1)+RD[1],0)+
ifelse(s>h & (s+L12-1)<=day, RD[2],0)+
ifelse(s>h & h>=day & (h-(LGP-L12))<=day,RD[2],0)
} else if(type==2){
#perennial crops
daily_rooting_depth <- RD[2]
}
return(daily_rooting_depth)
}
#### Effective precipitation ######################
P_eff<-function(daily_rooting_depth,soil_SAT,moisture,ET0,a,precipitation){
#ETa_full[i,day]=ifelse(day==1,0,ETa_full[i,day]) #if day=1 there is no ETa
#deficit=ifelse(a==1,(soil_AWC-moisture_mean)*1000*daily_rooting_depth,deficit_final)
deficit=(soil_SAT-moisture)*1000*daily_rooting_depth
#Calculation f P_eff from FAO-56
prec_eff=ifelse((precipitation[a])<=0.2*ET0[a],0,ifelse((precipitation[a])<deficit,precipitation[a],deficit))
return(prec_eff)
}
#### Crop coefficient #################
crop_coeff<-function(s,h,day,L1,L12,L123,L2_den,L4_den,LGP,kc_in,kc_mid,kc_end){
#Le prime 4 righe rappresentano un crop che si sviluppa nell'anno
kc= ifelse(h>s & day>=s & day<(s+L1-1), kc_in,0) +
ifelse(h>s & day>=(s+L1-1) & day<(s+L12-1), kc_in+((day-(s+L1)+1)/L2_den)*(kc_mid-kc_in),0) +
ifelse(h>s & day>=(s+L12-1) & day<(s+L123-1), kc_mid,0)+
ifelse(h>s & day>=(s+L123-1) & day<=h, kc_mid+((day-(s+L123)+1)/L4_den)*(kc_end-kc_mid),0) +
#Queste righe rappresentano un crop che si sviluppa a cavallo di 2 anni
#L1
ifelse(h<s & day>=s & day<(s+L1-1), kc_in,0) + #i giorni da s a fine anno
ifelse(h<s & day<(h-(LGP-L1)), kc_in,0) + #i giorni da fine anno a L1
#L2
ifelse(h<s & day>=(s+L1-1) & day<(s+L12-1), kc_in+((day-(s+L1)+1)/L2_den)*(kc_mid-kc_in),0) +
ifelse(h<s & day>=(h-(LGP-L1)) & day<(h-(LGP-L12)), kc_in+((366-s-L1+day)/L2_den)*(kc_mid-kc_in),0) +
#L3
ifelse(h<s & day>=(s+L12-1) & day<(s+L123-1), kc_mid,0)+
ifelse(h<s & day>=(h-(LGP-L12)) & day<(h-(LGP-L123)), kc_mid,0)+
#L4
ifelse(h<s & day>=(s+L123-1) & day<=(s+LGP-1), kc_mid+((day-(s+L123)+1)/L4_den)*(kc_end-kc_mid),0) +
ifelse(h<s & day>=(h-(LGP-L123)) & day<=h, kc_mid+((366-s-L123+day)/L4_den)*(kc_end-kc_mid),0)
return(kc)
}
#### water stress coefficient ################à
ws_coeff<-function(TAW,Dr,a,RAW){
ks <- (TAW - Dr[a]) / (TAW - RAW)
ks[is.nan(ks)] <- 0
ks[ks<0] <-0
ks[ks > 1] <- 1
return(ks)
}
#### Deficit final & deficit_final_limit ####################
def_function<-function(deficit_meteo,SAT_daily_limit,ETa,DP){
deficit_final <- ifelse(deficit_meteo >= 0 & deficit_meteo <= SAT_daily_limit,
deficit_meteo + ETa + DP,
ifelse(deficit_meteo > SAT_daily_limit,
SAT_daily_limit,
deficit_meteo+ETa+DP))
return(deficit_final)
}
def_lim_function<-function(TAW,ks,RAW){
deficit_final_limit <- TAW - ks * (TAW - RAW) #Deficit_min=RAW
return(deficit_final_limit)
}
#### irrigation requirement #################à
irrigation_function<-function(Dr,a){
if(Dr[a]>0){
irrigation <-  Dr[a] #irrigazione da applicare per riportare ETa alle condizioni di field capacity.
} else{
irrigation <- 0
}
Irr_req[a] <- irrigation #+ wat_soil
return(Irr_req[a])
}
#### Define Suggested irrigation scheduling ##########################
irr_sched_function <- function(RAW,irr_threshold_array,a,duration_past,Dr,date,Irr_req){
#Irrigation scenario and thresholds
Dr_lim=RAW * (1 + irr_threshold_array[1]) #Early threshold (optimal irrigation). E.g.: Dr_lim = RAW * (1+0)= RAW
if ( Dr[a] > Dr_lim){
Irr_sched=Irr_req[a]
} else {
Irr_sched=0
}
return(Irr_sched)
}
Evapotranspiration <- FAO_ET0_function(lat, tmin, tmax, Rs, wind, RH, RH_type, elev, date, in_greenhouse, "°C","W/m2","m/s","%","m")
ET0=Evapotranspiration$ET0
OWET=Evapotranspiration$OWET
ET0
