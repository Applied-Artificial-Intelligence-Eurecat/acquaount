<?php

// DATA Authorization -----------------------------
$url = "https://data.ira.tn/api/ds/query";
$curl = curl_init($url);
curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_POST, true);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
$headers = array(
   "Authorization: Bearer eyJrIjoidXJ4YVYwYlljajBXdmRlTExJNFJUdVZONU9zeElNQmIiLCJuIjoiQ0lUUklHIEFQUCIsImlkIjoxfQ==",
   "Content-type: application/json",
);
curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);


$data = <<<DATA
{
    "queries": [
        {
          "refId": "A",
          "datasource": {
            "type": "mysql"
          },
		  "datasourceId": 37,    
          "rawSql": "SELECT DATE_FORMAT(DATE_TIME, '%d-%m'), FORMAT(AVG(MEAS_3), 2), FORMAT(MIN(MEAS_3), 2), FORMAT(MAX(MEAS_3), 2) FROM ed_8452 WHERE DATE_TIME >= DATE_SUB(CURDATE(), INTERVAL 10 DAY) AND DATE_TIME < CURDATE() GROUP BY DATE_FORMAT(DATE_TIME, '%d-%m-%Y') HAVING COUNT(DATE_TIME) >= 45 ORDER BY DATE_TIME ",
          "format":"table"
          
        }
    ]
}
DATA;

curl_setopt($curl, CURLOPT_POSTFIELDS, $data);



//for debug only!
curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
$resp = curl_exec($curl);
curl_close($curl);
$panel_data = json_decode($resp, true);


$a = $panel_data['results'];
$b = $a['A'];
$c = $b['frames'];
$d = $c[0];
$e = $d['data'];
$final = $e['values'] ;

?>


<figure class="highcharts-figure">
    <div id="container" class="chart"></div>
<?php

// table
echo "<table id=\"datatable-temp\" hidden>";
echo "<tbody>";
// Create the table headers
echo "<tr>";
  echo "<th>Time</th>";
  echo "<th>T-MOY</th>";
  echo "<th>T-MIN</th>";
  echo "<th>T-MAX</th>";
echo "</tr>";
// Transpose the array
$transposed = array();
foreach ($final as $row) {
    foreach ($row as $key => $value) {
        $transposed[$key][] = $value;
    }
}
// Output the transposed array as an HTML table
foreach ($transposed as $row) {
    echo "<tr>";
    foreach ($row as $value) {
        echo "<td>" . $value . "</td>";
    }
    echo "</tr>";
}
echo "</tbody>";
echo "</table>";

?>
 

</figure>